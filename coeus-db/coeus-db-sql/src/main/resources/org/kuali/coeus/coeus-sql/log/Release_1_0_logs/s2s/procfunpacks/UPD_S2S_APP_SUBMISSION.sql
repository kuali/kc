CREATE OR REPLACE PROCEDURE UPD_S2S_APP_SUBMISSION (

	   AV_PROPOSAL_NUMBER 		  	IN	OSP$S2S_APP_SUBMISSION.PROPOSAL_NUMBER%TYPE :=NULL,
	   AV_SUBMISSION_NUMBER 		IN 	OSP$S2S_APP_SUBMISSION.SUBMISSION_NUMBER%TYPE :=NULL,
	   AV_COMMENTS					IN	OSP$S2S_APP_SUBMISSION.COMMENTS%TYPE :=NULL,
	   AV_STATUS					IN	OSP$S2S_APP_SUBMISSION.STATUS%TYPE :=NULL,
	   AV_GG_TRACKING_ID			IN	OSP$S2S_APP_SUBMISSION.GG_TRACKING_ID%TYPE :=NULL,
	   AV_AGENCY_TRACKING_ID		IN	OSP$S2S_APP_SUBMISSION.AGENCY_TRACKING_ID%TYPE :=NULL,
	   AV_RECEIVED_DATE 		  	IN	OSP$S2S_APP_SUBMISSION.RECEIVED_DATE%TYPE :=NULL,
	   AV_LAST_MODIFIED_DATE		IN	OSP$S2S_APP_SUBMISSION.LAST_MODIFIED_DATE%TYPE :=NULL,
	   AV_LAST_NOTIFIED_DATE		IN	OSP$S2S_APP_SUBMISSION.LAST_NOTIFIED_DATE%TYPE :=NULL,
	   AV_UPDATE_TIMESTAMP 		  	IN	OSP$S2S_APP_SUBMISSION.UPDATE_TIMESTAMP%TYPE :=NULL,
	   AV_UPDATE_USER    		  	IN	OSP$S2S_APP_SUBMISSION.UPDATE_USER%TYPE :=NULL,
	   AW_PROPOSAL_NUMBER			IN	OSP$S2S_APP_SUBMISSION.PROPOSAL_NUMBER%TYPE :=NULL,
	   AW_SUBMISSION_NUMBER			IN	OSP$S2S_APP_SUBMISSION.SUBMISSION_NUMBER%TYPE :=NULL,
	   AW_UPDATE_TIMESTAMP			IN	OSP$S2S_APP_SUBMISSION.UPDATE_TIMESTAMP%TYPE :=NULL,
	   AC_TYPE IN CHAR )

IS
    DATA_CHANGED    EXCEPTION;

BEGIN

  IF AC_TYPE = 'I' THEN
    INSERT INTO OSP$S2S_APP_SUBMISSION (
		   PROPOSAL_NUMBER,
		   SUBMISSION_NUMBER,
		   COMMENTS,
		   STATUS,
		   GG_TRACKING_ID,
		   AGENCY_TRACKING_ID,
		   RECEIVED_DATE,
		   LAST_MODIFIED_DATE,
		   LAST_NOTIFIED_DATE,
		   UPDATE_TIMESTAMP,
		   UPDATE_USER)
    VALUES (
		AV_PROPOSAL_NUMBER,
		AV_SUBMISSION_NUMBER,
		AV_COMMENTS,
		AV_STATUS,
		AV_GG_TRACKING_ID,
		AV_AGENCY_TRACKING_ID,
		AV_RECEIVED_DATE,
		AV_LAST_MODIFIED_DATE,
		AV_LAST_NOTIFIED_DATE,
		AV_UPDATE_TIMESTAMP,
		AV_UPDATE_USER) ;

  ELSIF AC_TYPE = 'U' THEN
    UPDATE OSP$S2S_APP_SUBMISSION SET
		PROPOSAL_NUMBER = AV_PROPOSAL_NUMBER,
		SUBMISSION_NUMBER = AV_SUBMISSION_NUMBER,
		COMMENTS = AV_COMMENTS,
		STATUS = AV_STATUS,
		GG_TRACKING_ID = AV_GG_TRACKING_ID,
		AGENCY_TRACKING_ID = AV_AGENCY_TRACKING_ID,
		RECEIVED_DATE = AV_RECEIVED_DATE,
		LAST_MODIFIED_DATE = AV_LAST_MODIFIED_DATE,
		LAST_NOTIFIED_DATE = AV_LAST_NOTIFIED_DATE,
		UPDATE_TIMESTAMP = AV_UPDATE_TIMESTAMP,
		UPDATE_USER = AV_UPDATE_USER
    WHERE
      PROPOSAL_NUMBER = AW_PROPOSAL_NUMBER AND
      SUBMISSION_NUMBER = (select max(submission_number) from osp$s2s_app_submission
	  					  where proposal_number= AW_PROPOSAL_NUMBER)
	AND UPDATE_TIMESTAMP = AW_UPDATE_TIMESTAMP ;

    IF SQL%NOTFOUND THEN
      RAISE DATA_CHANGED;
    END IF;

  ELSIF AC_TYPE = 'D' THEN
    DELETE FROM OSP$S2S_APP_SUBMISSION
    WHERE
      PROPOSAL_NUMBER = AW_PROPOSAL_NUMBER AND
      SUBMISSION_NUMBER = AW_SUBMISSION_NUMBER AND
      UPDATE_TIMESTAMP = AW_UPDATE_TIMESTAMP ;
  END IF;

EXCEPTION
  WHEN DATA_CHANGED THEN
    RAISE_APPLICATION_ERROR(-20100, 'DATA CHANGED BETWEEN RETRIEVE AND UPDATE');

END;
/

